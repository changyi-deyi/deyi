
@{
}

<link rel="stylesheet" type="text/css" href="/assets/css/sweetalert.css">
<script src="/assets/js/sweetalert.min.js"></script>
<script src="/assets/js/ng-file-upload/ng-file-upload.min.js"></script>
<script src="/assets/js/ng-file-upload/ng-file-upload-shim.min.js"></script>
<style type="text/css">
    .image-show {
    width: 100%;
    height: 100%;
    overflow-y:scroll;
    background-color black;
    z-index:9;
    position:absolute;
    }
    .image-show .image-size {
    width: 100%;
    z-index:10;
    display:table-cell;
    vertical-align:middle;
    }
    .image-show .image-size img{
    width: 100%;
    }
</style>
<div ng-app="ConsultationApp" ng-controller="ConsultationCtrl">
    <div class="header positionR blueBkg whiteTex">
        <a class="inlineB headerLeftIcon width3_2x height3_2x lineHeight3_2x blackTex" href="/Home/Home">
            <span class="iconfont font1x">&#xe60a;</span>
        </a>
        <span>免费咨询</span>
        <!--<a class="block headerRightIcon width3_2x height3_2x whiteTex" href="AddAddress.html">
            <span class="iconfont">&#xe615;</span>
        </a>-->
    </div>
    <div class="MT3x MB4_8x">
        <div class="textL clearfix">
            <!--个人信息-->
            <ul class="fl width100">
                <li class="whiteBkg MB0_4x">
                    <div class="P1_1x">
                        <p class="font09x">
                            <textarea class="borderBox width100 P0_8x border1 borderGray lineHeight1_5x" style="height: 10em;" placeholder="请您详细描述您的症状、做过的检查、用药情况、想要获得什么科室医生的帮助" rows="" cols="" ng-model="Text"></textarea>
                        </p>
                    </div>
                </li>
            </ul>
            <!--上传照片-->
            <!--<ul class="fl width100">
                <li class="whiteBkg">
                    <a class="P1_1x clearfix flex-box flex-item-center" href="ExchangeCoin.html">
                        <div class="fl">
                            <p class="Square_5x_pic grayTex">
                                <i class="iconfont font1_8x">&#xe604;</i>
                            </p>
                        </div>
                        <div class="fl width70 font09x" style="margin-left: 4%;">
                            <p>添加照片(选填)</p>
                            <p>点击添加病情或检查照片，方便医生确认</p>
                        </div>
                    </a>
                </li>
            </ul>-->
            <ul class="fl borderBox width100 P1_1x MB0_4x whiteBkg">
                <li class="">
                        <div class="clearfix MR0_4x">
                            <imaList ng-repeat="x in imaList">
                                <a class="fl Square_5x_pic MR0_4x MB0_4x" ng-click="imaDelete(x.ID,x.ImageURL,x.FileName)">
                                    <img src="{{x.ImageURL}}"/>
                                </a>
                            </imaList>
                            @*<div class="fl Square_5x_pic MR0_4x MB0_4x">
                                <i class="iconfont font1_8x grayTex">&#xe604;</i>
                            </div>*@
                            <div>
                                <button class="fl Square_5x_pic MR0_4x MB0_4x" type="file" ngf-select="uploadFiles($file, $invalidFiles)" accept="image/*" ngf-max-height="10000" ngf-max-size="100MB">
                                    <i class="iconfont font1_8x grayTex">&#xe604;</i>
                                </button>
                            </div>
                        </div>
                        <div class="width100 font085x MT0_4x grayTex">
                            <p>添加照片(选填)</p>
                            <p>点击添加病情或检查照片，方便医生确认</p>
                        </div>
                </li>
            </ul>
            <div class="fl width100 textC PT1_1x PB1_1x">
                <a class="btnSmall dy_btn blueBkg whiteTex" ng-click="ConsultationCommit()">提交咨询</a>
                @*<a class="btnSmall dy_btn lightgrayBkg whiteTex" href="Home.html">提交咨询</a>*@
            </div>
        </div>
    </div>
    <!--图片放大 弹层 开始-->
    @*<div ng-show="mymodal1" class="maskBg div">
        <div class="gpop-wapper gpop-wapper-pic">
            <div class="gpop-content">
                <div class="gpop-body box">
                    <img ng-src="{{ImaPath}}"/>
                </div>
                <div class="textC MT1x">
                    <a class="btnBorderSquare btnBorder_red redBkg whiteTex" ng-click="showCheckList()"><i class="iconfont MR0_4x">&#xe661;</i>删除此图片</a>
                </div>
            </div>
        </div>
    </div>*@
    <!--弹层 结束-->
    <!--删除档案提示 弹层 开始-->

    <div ng-show="mymodal1" class="maskBg div">
        <div class="gpop-wapper gpop-wapper-pic" style="top: 0;margin-top: 0;">
            <div class="gpop-content positionR">
                <div class="positionA textC MT1x" style="left: 0;top: 1em;">
                    <a class="btnBorderSquare btnBorder_gray grayBkg whiteTex" ng-click="showCheckList()"><i class="iconfont MR0_4x">&#xe661;</i>删除</a>
                </div>
                <div class="positionA MT1x" style="right: 0;top: 1em;">
                    <a class="btnBorderSquare btnBorder_gray grayBkg whiteTex" ng-click="deleteCancel()"><i class="iconfont MR0_4x">&#xe64d;</i>关闭</a>
                </div>
                <div class="gpop-body" id="gpop-body" style="max-height: 100vh; overflow-y: scroll;">
                    <img ng-src="{{ImaPath}}"/>
                </div>

            </div>
        </div>
    </div> 

    <div ng-show="mymodal2" class="maskBg div">
        <div class="gpop-wapper">
            <div class="gpop-content">
                <div class="gpop-body clearfix">
                    <div class="whiteBkg width80 MLRAuto P1_6x textC borderRad05x">
                        <p class="MB0_8x"><i class="iconfont font4x redTex">&#xe649;</i></p>
                        <p>确定删除此档案信息吗？</p>
                        <div class="textC MT2x">
                            <a class="btnBorderSquare btnBorder_gray grayBkg whiteTex PTB0_4x MR0_8x" ng-click="deleteCancel()">取消</a>
                            <a class="btnBorderSquare btnBorder_red redBkg whiteTex PTB0_4x" ng-click="deleteIma()">确 认</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!--弹层 结束-->
    <!--Loading 开始-->
    <div class="maskBg" ng-if="loading">
        <div class="gpop-wapper" style="background:none">
            <div class="gpop-content">
                <div class="gpop-body clearfix">
                    <div class="width80 MLRAuto P1_6x textC">
                        <div class="typing_loader"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Loading 结束-->
</div>
<script>
    var app = angular.module('ConsultationApp', ['ngFileUpload']);
    app.config(['$locationProvider', function ($locationProvider) {
        $locationProvider.html5Mode({
            enabled: true,
            requireBase: false,
            rewriteLinks: false
        });
    }]);
    app.controller('ConsultationCtrl', ['$scope', '$http','$location', 'Upload', '$timeout', function ($scope, $http, $location, Upload, $timeout) {
        $scope.mymodal1 = false;
        $scope.mymodal2 = false;
        $scope.GroupID = $location.search().g; // 咨询详情
        $scope.serviceCode = $location.search().s; // 服务编号
        var imaList = $scope.imaList = [];
        $scope.deleteID;
        $scope.deletePath;
        $scope.deleteUrl;
        $scope.loading = false;
        $scope.uploadFiles = function (file, errFiles) {
            $scope.f = file;
            $scope.errFile = errFiles && errFiles[0];
            if (file) {
                $scope.loading = true;
                file.upload = Upload.upload({
                    url: '/Sample/FileUpload',
                    data: { file: file, type: 2 }
                })

                file.upload.then(function (response) {
                    $timeout(function () {
                        file.result = response.data;
                        var fileJson = angular.fromJson(response.data.Data)
                        imaList.push({
                            ID: 0,
                            ImageURL: fileJson.Data.ImageURL, //咨询图片表.图片路径
                            FileName: fileJson.Data.FileName, //咨询图片表.文件名
                        });
                        $scope.loading = false;
                    });
                }, function (response) {
                    if (response.status > 0)
                        $scope.errorMsg = response.status + ': ' + response.data
                    $scope.loading = false;

                }, function (evt) {
                    file.progress = Math.min(100, parseInt(100.0 *
                        evt.loaded / evt.total));
                });
            }
        }

        $scope.ConsultationCommit = function () {
            if (angular.isUndefined($scope.Text) || $scope.Text == "") {
                swal("请输入咨询内容");
                return;
            }
            $http({
                method: 'post',
                url: '/Consultation/ConsultationCommit',
                params: {
                    GroupID: $scope.GroupID,
                    Text: $scope.Text,
                    AdvisoryIma: imaList,
                }
            }).success(function (req) {
                if (req.Code == "1") {
                    swal({
                        text: req.Message,
                        confirmButtonText: "确定",
                    }).then(() => {
                        window.location.href = '/MyHome/ConsultationList';
                    });
                } else {
                    swal(req.Message);
                }
            }).error(function () {
                swal("网络繁忙,请稍后再试！");
            });
        };

        $scope.imaDelete = function (ID, path, name) {
            $scope.ImaPath = path;
            $scope.deleteID = ID;
            $scope.deletePath = path;
            $scope.deleteUrl = name;
            $scope.mymodal1 = true;
        };
        $scope.showCheckList = function () {
            $scope.mymodal2 = true;
        }

        $scope.deleteCancel = function () {
            $scope.mymodal2 = false;
            $scope.mymodal1 = false;
        }

        $scope.deleteIma = function () {
            for (var i in $scope.imaList) {
                if ($scope.deletePath == $scope.imaList[i].ImageURL) {
                    $scope.imaList.splice(i, 1);
                };
            }
            $scope.mymodal2 = false;
            $scope.mymodal1 = false;
        }

                //$http({
                //    method: 'post',
                //    url: '/ConsultationCtrl/FileUpload',
                //    data: data,
                //    params: {
                //    }
                //}).success(function (req) {
                //    if (req.Code == "1") {
                //        $scope.form.image[data.guid] = data.result_value;
                //        $scope.thumb[data.guid].status = 'SUCCESS';
                //        console.log($scope.form)
                //    } else {
                //        var uploadList = $scope.uploadList = [];
                //    }
                //}).error(function () {
                //    alert(req.Code);
                //    alert("网络繁忙,请稍后再试！");
                //    });
    }]);
</script>
